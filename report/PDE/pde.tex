\section{Biharmonic equation}
\label{sec:PDE}

\newcommandx{\showSurf}[4][4=faceted]{  %% filename, N, labelZ, shader
  \begin{tikzpicture}
    \pgfplotsset{colormap={redblue}{rgb=(0,0,1) rgb=(1,1,1) rgb=(1,0,0)}}
    \begin{axis}[
        width=7.7cm,% height=7.5cm,
		    xmin=0, xmax=1, ymin=0, ymax=1,
	      xlabel=$x$, xtick distance=0.25,
	      ylabel=$y$, ytick distance=0.25,
        grid,
        zlabel={#3},
        mesh/ordering=x varies,
        mesh/cols=#2,
        mesh/rows=#2,
	      view={20}{50},
      ]
	    \addplot3 [
		    surf,
        point meta=explicit,
        opacity=0.95,
        shader=#4,
      ] table[meta=U]{#1};
    \end{axis}
  \end{tikzpicture}
}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}

\theoremstyle{definition}
\newtheorem{definition}{Definition}

In this section, we will consider the inhomogeneous, two-dimensional Biharmonic equation, with clamped boundary conditions on the domain $\Omega = [0, 1]^2$,
\begin{equation}\label{eq:PDE}
	\nabla^4 u = f \,\,\, \text{in} \,\,\, \Omega , \qquad u = \nabla^2 u = 0 \,\,\, \text{on} \,\,\, \partial\Omega,
\end{equation}
where $\nabla^2 = \partial_x^2 + \partial_y^2$ and $\nabla^4 = (\nabla^2)^2$.
We will solve it with finite difference schemes of both second and fourth order by solving the resulting matrix equations.
Then we will describe and implement a specialized \emph{Fast Poisson Solver} that solves the matrix equations very efficiently compared to general solvers.

\subsection{Analytical solution}
\label{sec:pde:anal}
\begin{figure}[b!]
\centering
\pgfplotsset{colormap={redblue}{rgb=(0,0,1) rgb=(1,1,1) rgb=(1,0,0)}}
\begin{tikzpicture}
\begin{axis}[
	width=7.5cm, height=7.5cm,
	xtick={-1,0,1}, ytick={-1,0,1},
	xlabel=$x$, ylabel=$y$,
	title={$u(x,y)$},
	% grid=major,
	declare function={
		myfunc(\x,\y)=sin(deg(pi*\x))*sin(deg(pi*\y)); % + 0.5*sin(deg(3*pi*\x))*sin(deg(3*pi*\y));
	},
	colormap name=redblue,
	view={0}{90},
	% colorbar right, colorbar style={ytick={-1,0,+1}},
]
\addplot3 [surf, domain=-1:1, contour filled={number=50}] {myfunc(x,y)};
\draw (+0.5, +0.5) node {$u(x,y)$};
\draw (-0.5, +0.5) node {$-u(x+1,y)$};
\draw (+0.5, -0.5) node {$-u(x,y+1)$};
\draw (-0.5, -0.5) node {$u(x+1,y+1)$};
\draw [->, thick] (+0.1, +0.5) -- (-0.1, +0.5);
\draw [->, thick] (+0.5, +0.1) -- (+0.5, -0.1);
\draw [->, thick] (-0.5, +0.1) -- (-0.5, -0.1);
\draw [->, thick] (+0.1, -0.5) -- (-0.1, -0.5);
\end{axis}
\end{tikzpicture}
\hfill
\begin{tikzpicture}
\begin{axis}[
	width=8cm, height=8cm,
	xtick={-1,0,1}, ytick={-1,0,1},
	xlabel=$x$, ylabel=$y$, zlabel={$u(x,y)$},
	% grid=major,
	declare function={
		myfunc(\x,\y)=sin(deg(pi*\x))*sin(deg(pi*\y)); % + 0.5*sin(deg(3*pi*\x))*sin(deg(3*pi*\y));
	},
	colormap name=redblue,
	% view={0}{90},
	% colorbar right, colorbar style={ytick={-1,0,+1}},
]
\addplot3 [surf, domain=-1:1] {myfunc(x,y)};
\end{axis}
\end{tikzpicture}
\caption{\label{continuationfig}
	The function $u(x,y)$ is originally defined on $[0,1]\times[0,1]$, but we extend the definition to the full $xy$-plane with the rules $u(x+1,y) = u(x,y+1) = -u(x,y)$.
	This makes $u(x,y)$ periodic and permits Fourier analysis.
	Here is the continuation on $[-1,1]\times[-1,1]$.
}
\end{figure}

To use Fourier analysis, let us extend the definition of $u(x,y)$ on $[0,1]\times[0,1]$ to the full $xy$-plane $[-\infty,+\infty]\times[-\infty,+\infty]$ as the antisymmetric continuation with the rules $u(x,y+1) = u(x+1,y) = -u(x,y)$.
The procedure is illustrated in \cref{continuationfig}.
Using the antisymmetry, the conditions $u = -u = 0$ and $\nabla^2 u = -\nabla^2 u = 0$ are automatically satisfied at the boundaries.
This can also be seen for the simple trial function in \cref{continuationfig}, which vanishes and inflects at the boundaries.
Now $u(x,y) = u(x+2,y) = u(x,y+2)$ is periodic in both directions with period $2$ and can therefore be written as a Fourier series \cite{Kreyszig}
\begin{equation*}
	u(x,y) = \sum_{m=-\infty}^{+\infty} \sum_{n=-\infty}^{+\infty} \hat{u}_{mn} e^{i 2 \pi m x / 2} e^{i 2 \pi n y / 2}.
\end{equation*}
Multiply by $e^{i 2 \pi m' x / 2} e^{i 2 \pi n' y / 2}$, integrate over $x$ and $y$ and use orthogonality to find the coefficients
\begin{equation*}
	\hat{u}_{mn} = \frac{1}{4} \integraltwo{u(x,y) e^{-i 2 \pi m x / 2} e^{-i 2 \pi n y / 2}}{x}{y}{-1}{+1}{-1}{+1}.
\end{equation*}
By the antisymmetry $u(x+1,y)=u(x,y+1)=-u(x,y)$ and the symmetry $u(x+1,y+1)=u(x,y)$, the Fourier coefficients satisfy
\begin{equation*}
	u_{m,n} = -u_{-m,n} = -u_{m,-n} = u_{-m,-n},
\end{equation*}
so $\hat{u}_{00} = -\hat{u}_{00} = 0$ and we can write the Fourier series as
\begin{equation*}
\begin{split}
	u(x,y) &= \sum_{m=1}^{+\infty} \sum_{n=1}^{+\infty} \hat{u}_{mn}
	\left( 
	  e^{+i \pi m x} e^{+i \pi n y}
	- e^{-i \pi m x} e^{+i \pi n y}
	- e^{+i \pi m x} e^{-i \pi n y}
	+ e^{-i \pi m x} e^{-i \pi n y}
	\right) \\
	       &= -4 \sum_{m=1}^{+\infty} \sum_{n=1}^{+\infty} \hat{u}_{mn} \sin(m \pi x) \sin(n \pi y)
\end{split}
\end{equation*}
after simplifying all complex expontentials using Euler's identity $e^{ix} = \cos x + i \sin x$.
Rescaling $\hat{u}_{mn} \rightarrow -\hat{u}_{mn}/4$, we then begin by expressing our analytical solution as the double sine series
\newcommand{\fourierseries}[3]{
	\sum_{#2=1}^{\infty} \sum_{#3=1}^{\infty} #1 \sin(#2 \pi x) \sin(#3 \pi y)
}
\newcommand{\fourierexpand}[1]{
	\fourierseries{\hat{#1}_{mn}}{m}{n}
}
\begin{equation}
u(x,y) = \fourierexpand{u}.
\label{pde:equation:fourierexpansion}
\end{equation}

Plug this Fourier series into \cref{eq:PDE} and act with the biharmonic operator to get
\begin{equation*}
\nabla^4 u(x,y) = \fourierseries{\left((m\pi)^2+(n\pi)^2\right)^2 \hat{u}_{mn}}{m}{n} = f(x,y).
\end{equation*}
For simplicity, we \emph{restrict ourselves to sources that can also be written}
\begin{equation}
	f(x,y) = \fourierexpand{f}.
\end{equation}

The Fourier series for $\nabla^4 u(x,y)$ and $f(x,y)$ can be equal only if their coefficients are equal.
This can be seen formally by multiplying both by $\sin(2m'\pi x) \sin(2n'\pi y)$, integrating over $x$ and $y$ and using orthogonality of the sine functions,
\begin{equation*}
	\integral{\sin(m\pi x) \sin(m' \pi x)}{x}{0}{1} = \frac{1}{2} \delta_{mm'}.
\end{equation*}
Therefore, the coefficients of the solution are
\begin{equation}
	\hat{u}_{mn} = \frac{\hat{f}_{mn}}{\left((m\pi)^2+(n\pi)^2\right)^2},
\end{equation}
and the solution $u(x,y)$ is available by summing its Fourier series \ref{pde:equation:fourierexpansion}.

If we know $\hat{f}_{mn}$, it is straightforward to compute $\hat{u}_{mn}$ and thus the solution $u(x,y)$ itself from its Fourier series.
If we only know $f(x,y)$, we can find the coefficients by using the orthogonality of the sine functions again.
Multiply the Fourier series by $\sin(m' \pi x) \sin(n' \pi y)$ and integrate over $x$ and $y$ to get
\begin{equation*}
\begin{split}
  & \,\, \integraltwo{f(x,y) \sin(m' \pi x) \sin(n' \pi y)}{x}{y}{0}{1}{0}{1} \\
= & \,\, \sum_{m=1}^{\infty} \sum_{n=1}^{\infty} \hat{f}_{mn} \underbrace{\integral{\sin(m\pi x)\sin(m'\pi x)}{x}{0}{1}}_{\delta_{mm'}/2} \underbrace{\integral{\sin(\pi y)\sin(n'\pi y)}{y}{0}{1}}_{\delta_{nn'}/2} \\
= & \,\, \hat{f}_{m'n'} / 4.
\end{split}
\end{equation*}
Read from bottom to top,
\begin{equation}
\hat{f}_{mn} = 4 \integraltwo{f(x,y) \sin(m \pi x) \sin(n \pi y)}{x}{y}{0}{1}{0}{1}.
\end{equation}

Note that a general source $f(x,y)$ may only be represented exactly by an infinite Fourier series.
To make the Fourier series solution viable, we must cut it off to include only a finite number of terms.
In this case, we should analyze $f(x,y)$ to make sure that we exclude only Fourier modes that contribute insignificantly to the solution.
However, we can also construct problems with a finite number of terms in the \emph{exact} solution by simply defining the source $f(x,y)$ in terms of a finite number of nonzero Fourier coefficients.

%% b)

\subsection{Finite difference method}
\label{sec:pde:numerical_solution}

\newcommand{\crossStencilInternal}[5]{
    \draw (0,-1) node{$#1$} -- (0,+1) node{$#2$};
    \draw (-1,0) node{$#3$} -- (+1,0) node{$#4$};
	\draw (0,0)  node{$#5$};
}
\newcommand{\xStencilInternal}[4]{
    \draw (-1,-1) node{$#1$} -- (+1,+1) node{$#2$};
    \draw (-1,+1) node{$#3$} -- (+1,-1) node{$#4$};
}
\newcommand{\crossStencil}[5]{%
  \begin{tikzpicture}[scale=1.0,baseline={([yshift=-0.5ex]current bounding box.center)}, every node/.style={scale=1.0,inner sep=0pt, minimum size=5.5ex, fill=white}, nodes={draw, circle}]
    \crossStencilInternal{#1}{#2}{#3}{#4}{#5}
  \end{tikzpicture}
}
\newcommand{\xStencil}[4]{%
  \begin{tikzpicture}[scale=1.0,baseline={([yshift=-0.5ex]current bounding box.center)}, every node/.style={scale=1.0,inner sep=0pt, minimum size=5.5ex, fill=white}, nodes={draw, circle}]
    \xStencilInternal{#1}{#2}{#3}{#4}
  \end{tikzpicture}
}
\newcommand{\boxStencil}[9]{
  \begin{tikzpicture}[scale=1.0,baseline={([yshift=-0.5ex]current bounding box.center)}, every node/.style={scale=1.0,inner sep=0pt, minimum size=5.5ex, fill=white}, nodes={draw, circle}]
	\xStencilInternal{#6}{#7}{#8}{#9};
	\crossStencilInternal{#1}{#2}{#3}{#4}{#5};
  \end{tikzpicture}
}

The Biharmonic equation \ref{eq:PDE} can be transformed to a system of Poisson equations
\begin{subequations}\label{eq:PDE-poisson}
\begin{align}
	&\nabla^2 g = f \,\,\, \text{in} \,\,\, \Omega, \qquad g = 0 \,\,\, \text{on} \,\,\, \partial\Omega  \label{eq:pde:poissonsystem1} \\
	&\nabla^2 u = g \,\,\, \text{in} \,\,\, \Omega, \qquad u = 0 \,\,\, \text{on} \,\,\, \partial\Omega. \label{eq:pde:poissonsystem2}
\end{align}
\end{subequations}
Instead of solving the Biharmonic equation directly with a stencil for $\nabla^4$, we will solve the two Poisson equations successively with a Poisson stencil $\nabla_n^2 \approx \nabla^2$ only.
First, we solve \ref{eq:pde:poissonsystem1} numerically with the exact known source $f$ to obtain an intermediate solution $G \approx g$.
Then we solve \ref{eq:pde:poissonsystem2} numerically to obtain the final solution $U \approx u$, but this time we only have access to the approximate source $G \approx g$.

We divide $[0,1] \times [0,1]$ into the uniformly spaced two-dimensional grid
\begin{center}
\begin{tikzpicture}
\newcommand{\drawboxx}[3]{
	\draw [#3] (#1,#2) -- (#1+2,#2);
	\draw [#3] (#1,#2) -- (#1,#2+2);
	\draw [#3] (#1+2,#2) -- (#1+2,#2+2);
	\draw [#3] (#1,#2+2) -- (#1+2,#2+2);
	\draw [#3] (#1+1,#2) -- (#1+1,#2+2);
	\draw [#3] (#1,#2+1) -- (#1+2,#2+1);
}

\drawboxx{0}{0}{solid}
\drawboxx{0}{4}{solid}
\drawboxx{4}{0}{solid}
\drawboxx{4}{4}{solid}

\drawboxx{0}{2}{dotted}
\drawboxx{2}{0}{dotted}
\drawboxx{4}{2}{dotted}
\drawboxx{2}{4}{dotted}

\drawboxx{2}{2}{dotted}

\foreach \x in {0,1,2,3,4,5,6} {
	\foreach \y in {0,1,2,3,4,5,6} {
		\node at (\x, \y) [circle, fill, inner sep=1.2pt] {};
	}
}
\node at (0,0) [below, yshift=-2mm] {$x_0$};
\node at (1,0) [below, yshift=-2mm] {$x_1$};
\node at (2,0) [below, yshift=-2mm] {$x_2$};
\node at (3,0) [below, yshift=-2mm] {$x_m$};
\node at (4,0) [below, yshift=-2mm] {$x_{N-1}$};
\node at (5,0) [below, yshift=-2mm] {$x_{N  }$};
\node at (6,0) [below, yshift=-2mm] {$x_{N+1}$};

\node at (0,0) [left, xshift=-2mm] {$y_0$};
\node at (0,1) [left, xshift=-2mm] {$y_1$};
\node at (0,2) [left, xshift=-2mm] {$y_2$};
\node at (0,3) [left, xshift=-2mm] {$y_n$};
\node at (0,4) [left, xshift=-2mm] {$y_{N-1}$};
\node at (0,5) [left, xshift=-2mm] {$y_{N  }$};
\node at (0,6) [left, xshift=-2mm] {$y_{N+1}$};

\node at (6,0.5) [right, xshift=+2mm] {$h$};
\node at (6,1.5) [right, xshift=+2mm] {$h$};
\node at (6,4.5) [right, xshift=+2mm] {$h$};
\node at (6,5.5) [right, xshift=+2mm] {$h$};

\node at (0.5,6) [above, yshift=+2mm] {$h$};
\node at (1.5,6) [above, yshift=+2mm] {$h$};
\node at (4.5,6) [above, yshift=+2mm] {$h$};
\node at (5.5,6) [above, yshift=+2mm] {$h$};

\end{tikzpicture}
.
\end{center}

% task c)
The boundary conditions in \ref{eq:PDE} already tell us that $g = u = 0$ on $\partial \Omega$, so we will only solve for $U$ in the interior $1 \leq m,n \leq N$.
To do so, we approximate the Laplacian $\nabla^2$ with the $5$-point and $9$-point stencils % task c
\begin{equation*}
	\nabla_5^2 = \crossStencil{1}{1}{1}{1}{-4}
	\qquad \text{and} \qquad
	\nabla_9^2 = \boxStencil{\frac23}{\frac23}{\frac23}{\frac23}{-\frac{10}{3}}{\frac16}{\frac16}{\frac16}{\frac16} 
	\,.
\end{equation*}
The diagrams define the stencils by their action on some function.
For example,
\begin{equation*}
	\nabla_5^2 u(x,y) = \frac{-4u(x,y) + u(x+h,y) + u(x-h,y) + u(x,y+h) + u(x,y-h)}{h^2},
\end{equation*}
and $\nabla_9^2$ acts similarly, but also includes terms like $u(x+h, y+h)$.
We will solve Poisson equations with
\begin{equation}
	\nabla_5^2 U = F
	\qquad \text{and} \qquad
	\nabla_9^2 U = \left( 1 + \frac{h^2}{12} \nabla_5^2 \right) F
	,
\label{eq:pde:stencilequation}
\end{equation}
and will later see that the former is $\Oh(h^2)$, while the latter is $\Oh(h^4)$.

Next, we turn to formulating \cref{eq:pde:stencilequation} as matrix equations.
We define $U$, $G$ and $F$ as flattened vectors of the discretized functions for $u$, $g$ and $f$ following the same procedure as in \cref{sec:exc3:numerical}.
For the $5$-point stencil, first define the one-dimensional second order central finite difference matrix,
$$
J_5 =
\begin{bmatrix}
  -2 & 1 &   \\
  1 & -2 & 1 &  \\
  & 1 & -2 & 1 & \\
  &&\ddots&\ddots&\ddots\\
  &&& 1 & -2 & 1\\
  &&&& 1 & -2
\end{bmatrix}
.
$$
Using the Kroenecker product $\otimes$ and the Kroenecker sum $\oplus$, the $5$-point stencil is represented by
\begin{equation}
K_5 =
\begin{bmatrix}
  J_5 & 0 & 0 & \\
  0 & J_5 & 0 & \ddots \\
  0 & 0 & J_5 & \ddots \\
  &\ddots&\ddots&\ddots
\end{bmatrix}
+
\begin{bmatrix}
  -2I & I & 0 & \\
  I & -2I & I & \ddots \\
  0 & I & -2I & \ddots  \\
  & \ddots & \ddots & \ddots & \\
\end{bmatrix}
= I \otimes J_5
+ J_5 \otimes I 
= J_5 \oplus J_5
.
\label{eq:pde:fivepointkroeneckersum}
\end{equation}

For the $9$-point stencil, note that it can be split into
$$
\boxStencil{\frac23}{\frac23}{\frac23}{\frac23}{-\frac{10}{3}}{\frac16}{\frac16}{\frac16}{\frac16}
\quad = \quad
\crossStencil{\frac23}{\frac23}{\frac23}{\frac23}{-\frac{10}{3}}
\quad + \quad
\xStencil{\frac16}{\frac16}{\frac16}{\frac16}
$$
The first term can be handled like the $5$-point stencil and is represented by $J_9 \oplus J_9$ with
\begin{equation*}
J_9 = 
\frac{1}{3}
\begin{bmatrix}
  -5 & 2 &   \\
  2 & -5 & 2 &  \\
  & 2 & -5 & 2 & \\
  &&\ddots&\ddots&\ddots\\
  &&& 2 & -5 & 2\\
  &&&& 2 & -5
\end{bmatrix}
.
\end{equation*}
The second stencil picks out neighbours located diagonally from the center point and is represented by
\begin{equation*}
\frac{1}{\sqrt{6}}
\begin{bmatrix}
0 & \Sigma &   \\
\Sigma & 0 & \Sigma & \ddots \\
  & \Sigma & 0 & \ddots \\
& \ddots & \ddots & \ddots \\
\end{bmatrix}
= 
\Sigma \otimes \Sigma
\qquad \text{with} \qquad
\Sigma =
\frac{1}{\sqrt{6}}
\begin{bmatrix}
0 & 1  \\
1 & 0 & 1 & \ddots \\
  & 1 & 0 & \ddots \\
  & \ddots & \ddots & \ddots \\
\end{bmatrix}
.
\end{equation*}

Summarizing, the finite difference matrix equations corresponding to \ref{eq:pde:stencilequation} that we will solve are
\begin{equation}
\begin{alignedat}{4}
	K_5 U &= h^2 F_5
	&& \qquad \text{with} \qquad
	F_5 = F
	&& \qquad \text{and} \qquad
	K_5 = J_5 \oplus J_5 \\
	K_9 U &= h^2 F_9
	&& \qquad \text{with} \qquad
	F_9 = \left( I + \frac{1}{12}K_5 \right) F
	&& \qquad \text{and} \qquad
	K_9 = J_9 \oplus J_9 + \Sigma \otimes \Sigma.
\end{alignedat}
\label{eq:pde:matrixequations}
\end{equation}
\emph{Warning:} 
We know that $U = 0$ on the boundary, so we will only solve for $U$ in the interior $N \times N$ grid.
But $F$ need \emph{not} be zero on the boundary.
When calculating the right side of the $9$-point equation, we must therefore \emph{first} use the $(N+2) \times (N+2)$ grid \emph{with} the boundary to make $K_5$ sample $F$ there, \emph{then} cut away the boundary and go back to the $N \times N$ grid before solving for $U$ in the interior.

We will solve the matrix equations with sparse matrices. \cite{scipy_sparse} 
We first represent $J_5$, $J_9$ and $\Sigma$ with sparse matrices and then use \cite{scipy_kron} to construct sparse representations of Kroenecker products and sums.

%% Let us defne an infinity norm for convenience
\newcommand{\inorm}[1]{
\lVert #1 \rVert_\infty
}

\subsection{Stability and order of the five and nine point stencils}
\begin{definition}
  A proper $n$-point stencil $\nabla_n^2$ with weights $a_i$ has the properties
  \begin{equation*}
  	\nabla_n^2 f(x_0) = \sum_{i=0}^{n-1} a_i f(x_i),
	\qquad 
	a_i > 0 \,\, \text{for} \,\, i \geq 1
	\qquad \text{and} \qquad
	\sum_{i=1}^{n-1} a_i = -a_0,
  \end{equation*}
  where $x_i$ are the neighbouring points of $x_0$.
\end{definition}

\begin{lemma}[Discrete maximum principle]\label{pde:lemma:max}
If $\nabla_n^2 f \geq 0$ on $\Omega$ and $\nabla_n^2$ is a proper stencil, then $f$ attains its maximum value on $\partial \Omega$, that is
$$
\max_\Omega f  \leq \max_{\partial \Omega} f.
$$
\end{lemma}
\begin{proof}
Suppose instead that $\max_\Omega f > \max_{\partial \Omega} f$.
Then there is an internal grid point $x_0$ on which $f$ attains its maximum value $f(x_0) \geq f(x_i)$, where $x_i$ are the neighbouring points $x_i$.
Then
\begin{equation}
  -a_0 f(x_0)
  = \sum_{i=1}^{n-1} a_i f(x_i) - \nabla_n^2 f(x_0)
  \leq \sum_{i=1}^{n-1} a_i f(x_i)
  \leq \sum_{i=1}^{n-1} a_i f(x_0)
  = -a_0 f(x_0).
\end{equation}
The right side is equal to the left side, so equality must hold throughout and $\sum_{i=1}^{n-1} a_i (f(x_0) - f(x_i)) = 0$.
The stencil is proper, so $a_i > 0$ for $i \geq 1$ and all the are nonnegative, so it can only vanish if $f(x_0) = f(x_1) = \dots = f(x_{n-1})$.
Repeating the argument at each neighbour $x_i$, and then to their neighbours and so on, we ultimately reach the conclusion that the same value is also attained on $\partial \Omega$, so we have a contradiction.
\end{proof}

\begin{lemma}\label{pde:lemma:bound}
  If there exists a function $\phi_n(x,y) \geq 0$ such that $\nabla_n^2 \phi_n = 1$ on $\Omega$ for a proper stencil $\nabla_n^2$, and $U$ is a discrete function that equals zero on $\partial \Omega$, then
  \begin{equation}
    \inorm{U} \leq \max_{\partial\Omega} \lvert \phi_n \rvert
    \inorm{\nabla_n^2 U}.
  \end{equation}
\end{lemma}
\begin{proof}
Let $\inorm{\nabla_n^2 U} = M$.
Then
$$
\nabla_n^2 (U + \phi_n M) = \nabla_n^2 U +  M \geq 0.
$$
Since $\nabla_n^2$ is a proper stencil, $U + \phi_n M$ attains its maximum value on $\partial \Omega$ by lemma \ref{pde:lemma:max}.
Thus
\begin{equation*}
\inorm{U}
\leq \inorm{U + \phi_n M}
\leq \max_{\partial \Omega} \lvert U + \phi_n M\rvert
= \max_{\partial\Omega} \lvert \phi_n \rvert M
= \max_{\partial\Omega} \lvert \phi_n \rvert \inorm{\nabla_n^2 U}. \qedhere
\end{equation*}
\end{proof}

\begin{remark}
  For the five and nine point stencil, such functions do exist.
  Suspecting that the stencils are second and fourth order, we look for second and fourth order polynomials in $x$ and $y$ with this property.
  We find 
  \begin{equation}
    \phi_5(x,y) = \frac14 \left(\left(x-\frac12\right)^2 + \left(y-\frac12\right)^2\right)
    \label{pde:equation:phi5}
  \end{equation}
  with the property $\nabla_5^2 \phi_5(x,y) = 1$, taking the values $0 \leq \phi_5(x,y) \leq 1/8$ on $\Omega$ and attaining the maximum on $\partial \Omega$.
  \newcommand{\phinine}{\frac{1}{5} \left(\left(x-\frac{1}{2}\right)^4+\left(y-\frac{1}{2}\right)^4\right) - \frac{6}{5} \left(x-\frac{1}{2}\right)^2\left(y-\frac{1}{2}\right)^2 + \frac{1}{4} \left(\left(x-\frac{1}{2}\right)^2+\left(y-\frac{1}{2}\right)^2\right)}
  Similarly, the polynomial
  \begin{equation}
  \phi_9(x,y) = \phinine
  \label{pde:equation:phi9}
  \end{equation}
  is such that $\nabla_9^2 \phi_9(x,y) = 1$, takes the values $0 \leq \phi_9(x,y) \leq 3/40$ on $\Omega$ and attains the maximum on $\partial \Omega$.
  Both are shown in \cref{pde:figure:phi}.
\end{remark}

\newcommand{\phidisplay}[3]{
\begin{tikzpicture}
\begin{axis}[
	width=8.2cm, height=7.5cm,
	zmin=0.0,zmax=0.13,
	xlabel=$x$, xtick distance=0.25,
	ylabel=$y$, ytick distance=0.25,
	ztick={0,#2, 1/8}, zticklabels={0,#2, 1/8},
	scaled ticks=false,
	grid,
	title={$#3$},
  point meta max=0.13,  % Sets max value for cmap 
]
	\addplot3 [
		surf,
		domain=0:1,
	] {#1};
\end{axis}
\end{tikzpicture}
}

\begin{figure}[t]
\centering
\phidisplay{1/4*((x-1/2)^2+(y-1/2)^2)}{-1}{\phi_5(x,y)}
\phidisplay{1/5*((x-1/2)^4+(y-1/2)^4)-6/5*(x-1/2)^2*(y-1/2)^2+1/4*((x-1/2)^2+(y-1/2)^2)}{3/40}{\phi_9(x,y)}
\caption{\label{pde:figure:phi}The functions $\phi_5(x,y)$ and $\phi_9(x,y)$ range from $\phi_5(\frac12,\frac12)=\phi_9(\frac12,\frac12)=0$ at the center to $\phi_5(0,0) = 1/8$ and $\phi_9(0,0)=3/40$ at the boundaries of $[0,1]\times[0,1]$.}
\end{figure}

%% 3
\begin{theorem}[Five-point stencil stability on Poisson equation]\label{thm:five}
If $\nabla^2 u = f$ and $\nabla_5^2 U = f$ in $\Omega$, $u = U$ on $\partial \Omega$ and $D^4 u < \infty$ in $\Omega$, then the $5$-point stencil is consistent, stable and convergent of order $h^2$ with
$$ \inorm{u - U} \leq \frac18 \inorm{\nabla_5^2(u-U)} = Ch^2. $$
\end{theorem}
\begin{proof}
By lemma \ref{pde:lemma:bound} with $\phi_5$ from \ref{pde:equation:phi5},
$$
\inorm{u - U} \leq \frac18 \inorm{\nabla_5^2 (u  - U)}.
$$
Taylor expand all terms in $\nabla_5^2 u$ around the center of the stencil to get
\begin{equation}
\begin{split}
	\nabla_5^2 u &= \nabla^2 u + C h^2 D^4 u  \\
	             &\leq f + Ch^2 \abs{D^4 u}_\infty \\
	             &\leq f + Ch^2.\\
\end{split}
\label{eq:pde:taylornabla2}
\end{equation}
The second term is the remainder term, where by $D^m u$ we mean \emph{some} combination $\sum_{n=0}^m c_n \partial_x^n \partial_y^{m-n} u$ of $m$-derivatives evaluated \emph{somewhere} inside $\Omega$.
By $\abs{D^m u}_\infty$, we mean the maximum value of any $m$-derivative $\max_{n=0}^m \abs{\partial_x^n \partial_y^{m-n} u}$ in $\Omega$.
Note that terms with odd powers of $h$ vanish due to the symmetry of the stencil.
Finally, substitute $f = \nabla_5^2 U$ to conclude that
\begin{equation*}
  \inorm{u - U}
  \leq \frac18 \inorm{\nabla_5^2 (u  - U)}
  \leq C h^2 \abs{D^4 u}_\infty
  \leq C h^2. \qedhere
\end{equation*}
\end{proof}


%% 3
\begin{theorem}[Nine-point stencil stability on Poisson equation]\label{thm:nine}
If $\nabla^2 u = f$ and $\nabla_9^2 U = f + \frac{h^2}{12} \nabla_5^2 f$ in $\Omega$, $u = U$ on $\partial \Omega$ and $D^4 u, D^6 u < \infty$ in $\Omega$,
then the $9$-point stencil is consistent, stable and convergent of order $h^4$ with
$$
\inorm{u - U} \leq \frac{3}{40} \inorm{\nabla_9^2(u-U)} \leq C h^4.
$$
\end{theorem}
\begin{proof}
By lemma \ref{pde:lemma:bound} with $\phi_9$ from \ref{pde:equation:phi9},
$$
\inorm{u - U} \leq \frac{3}{40} \inorm{\nabla_9^2 (u  - U)}.
$$
Taylor expand all terms in $\nabla_9^2 u$ around the center of the stencil to get
\begin{equation*}
\begin{split}
\nabla_9^2 u &= \nabla^2 u + \frac{h^2}{12} \nabla^4 u + C h^4 D^6 u \\
             &\leq f + \frac{h^2}{12} \nabla^2 f + Ch^4 \abs{D^6 u}_\infty \\
             &\leq f + \frac{h^2}{12} \nabla^2 f + Ch^4.\\
\end{split}
\end{equation*}
From the Taylor expansion \ref{eq:pde:taylornabla2} with $u \leftrightarrow f$, we also know that
\begin{equation*}
\begin{split}
\nabla^2 f &\leq \nabla_5^2 f + Ch^2 \abs{D^4 f}_\infty \\
           &\leq \nabla_5^2 f + Ch^2 \abs{D^6 u}_\infty \\
           &\leq \nabla_5^2 f + Ch^2.
\end{split}
\end{equation*}
Together, the two Taylor expansions imply
\begin{equation}
	\nabla_9^2 u \leq f + \frac{h^2}{12} \nabla_5^2 f + Ch^4
\label{eq:pde:taylornabla22}
\end{equation}
Finally, substitute $f + \frac{h^2}{12} \nabla_5^2 f = \nabla_9^2$ to get
\begin{equation*}
  \inorm{u-U} \leq \frac{3}{40} \inorm{\nabla_9^2 (u - U)} \leq C h^4. \qedhere
\end{equation*}
\end{proof}

(TODO: using $u$ with $f$ is also weird. using $u$ with $g$ would be more consistent with what we already have)

(TODO: improve biharmonic theorems, make simpler?)

\begin{theorem}[Five-point stencil order and stability on Biharmonic equation]
If $\nabla^2 u = g$, $\nabla_5^2 U = G$, $\nabla^2 g = f$, $\nabla_5^2 G = f$ in $\Omega$ and $u=U$ and $g=G$ on $\partial \Omega$ and derivatives up to $6$-th order of $u$ are bounded,
then the $5$-point stencil $(\nabla_5^2)^2$ is consistent, stable and convergent of order $h^2$ on the Biharmonic equation.
\label{pde:lemma:fivebi}
\end{theorem}
\begin{proof}
We \emph{cannot} apply \cref{thm:five} to $\nabla^2 u = g$ and $\nabla_5^2 U = G$ since $g \neq G$.
But we \emph{can} apply \cref{thm:five} to $\nabla^2 u = g$ and $\nabla_5^2 U' = g$.
This gives
\begin{equation*}
\begin{split}
	\inorm{u-U} &= \inorm{(u-U') - (U-U')} \\
                &\leq \inorm{u-U'} + \inorm{U-U'} \\
\end{split}
\end{equation*}
Now apply \cref{thm:five} to the first term and \cref{pde:lemma:bound} with $\phi_5$ from \ref{pde:equation:phi5} to the second term to get
\begin{equation*}
\begin{split}
	\inorm{u-U} &\leq \frac18 \inorm{\nabla_5^2(u-U')} + \frac18 \inorm{\nabla_5^2(U-U')} \\
				&\leq Ch^2 + \frac18 \inorm{G-g}. \\
\end{split}
\end{equation*}
Finally, apply \cref{thm:five} again to $\nabla^2 g = \nabla_5^2 G = f$ to show that also $\inorm{g-G} \leq Ch^2$, so $\inorm{u-U} \leq Ch^2$ and $(\nabla_5^2)^2$ is $\Oh(h^2)$.

To show consistency, note that \cref{thm:five} already ensures consistency for the Poisson equation.
But if $\nabla_5^2(u-U) \rightarrow 0$ as $h \rightarrow 0$, then also $\nabla_5^2 \nabla_5^2 (u-U) \rightarrow 0$, so $(\nabla_5^2)^2$ is also consistent on the Biharmonic equation.
By Lax' equivalence lemma, it is therefore also stable.
\end{proof}

\begin{theorem}[Nine-point stencil order and stability on Biharmonic equation]
If $\nabla^2 u = g$, $\nabla_9^2 U = (1+\frac{h^2}{12} \nabla_5^2 ) G$, $\nabla^2 g = f$, $\nabla_9^2 G = (1+\frac{h^2}{12} \nabla_5^2) f$ in $\Omega$ and $u=U$ and $g=G$ on $\partial \Omega$ and derivatives up to $8$-th order of $u$ are bounded, 
then the $9$-point stencil $(\nabla_9^2)^2$ is consistent, stable and convergent of order $h^4$ on the Biharmonic equation.
\end{theorem}
\begin{proof}
We \emph{cannot} apply \cref{thm:nine} to $\nabla^2 u = g$ and $\nabla_9^2 U = (1 + \frac{h^2}{12} \nabla_5^2) G$, since $g \neq G$.
But we \emph{can} apply \cref{thm:nine} to $\nabla^2 u = g$ and $\nabla_9^2 U' = (1 + \frac{h^2}{12} \nabla_5^2) g$.
This gives

(use \cref{pde:lemma:bound}!)
\begin{equation*}
\begin{split}
	\inorm{u-U} &=    \inorm{(u-U') - (U-U')} \\
                &\leq \inorm{u-U'} + \inorm{U-U'} \\
\end{split}
\end{equation*}
Now apply \cref{thm:nine} to the first term and \cref{pde:lemma:bound} with $\phi_9$ from \ref{pde:equation:phi9} to the second term to get
\begin{equation*}
\begin{split}
	\inorm{u-U} &\leq \frac{3}{40} \inorm{\nabla_9^2(u-U')} + \frac{3}{40} \inorm{\nabla_9^2(U-U')} \\
				&\leq Ch^4 + \frac{3}{40} \inorm{(G-g)+\frac{h^2}{12} \inorm{\nabla_5^2 (G-g)}}\\
				&\leq Ch^4 + \frac{3}{40} \inorm{(G-g)} + \frac{3}{40} \frac{h^2}{12} \inorm{\nabla_5^2 (G-g)} \\
\end{split}
\end{equation*}
Finally, apply \cref{thm:nine} again on the two last terms to show that they are also $\Oh(h^4)$, so $\inorm{u-U} \leq Ch^4$ and $(\nabla_9^2)^2$ is $\Oh(h^2)$.

Consistency and stability is shown like in \cref{pde:lemma:fivebi}.
\end{proof}

\begin{equation*}
\begin{split}
\inorm{u-U} &\leq \frac18 \inorm{\nabla_5^2(u-U)} \\
            &\leq \frac18 \inorm{\nabla^2 u + Ch^2 \inorm{D^4 u} - \nabla_5^2 U} \\
			&\leq \frac18 \inorm{g - G} + \frac18 Ch^2 \inorm{D^4 u} \\
			&\leq C h^2 \inorm{D^4 u} + Ch^2 \inorm{D^4 u} \\
			&\leq C h^2 \inorm{D^4 u}.
\end{split}
\end{equation*}

\subsubsection{Stability when solving the Biharmonic equation}
Theorems \ref{thm:five} and \ref{thm:nine} shows that the solutions to the Poisson equation using the five and nine point stencils are stable and of order 2 and 4 respectively.
We will here show that the order of the solution to the system of Poisson equations in \eqref{eq:PDE-poisson} will be of the same order.

We will begin with the five point stencil.
One must show that
$$
\inorm{U - u} \leq Ch^2,
$$
where $u$ is the exact solution $\nabla^4 u = f$.
Solving the Biharmonic equation as a system of Poisson equations consists of two steps 1) $\nabla^2 g = f$ and 2) $\nabla^2 u = g$.
We find an approximation $G$ to $g$, where by theroem \ref{thm:five}
$$
\inorm{G - g} \leq C h^2.
$$
When solving step 2) we would ideally solve
$$
\nabla_5^2 U_e = g,
$$
in which case theorem \ref{thm:five} implies that
$$
\inorm{U_e - u} \leq C h^2.
$$
However we end up solving
$$
\nabla_5^2 U = G = g + \gamma(x, y) h^2.
$$
We have that
\begin{equation}
  \nabla_5^2 (U - U_e) = \gamma(x, y) h^2,
\end{equation}
By lemma \ref{pde:lemma:bound}
$$
\inorm{U - U_e} \leq \frac18 \inorm{\nabla_5^2 (U - U_e)} = \frac18 \inorm{\gamma(x, y) h^2} \leq C h^2.
$$
Thus,
\begin{align*}
  \inorm{U - u} &= \inorm{U - U_e + U_e - u}\\
  &\leq \inorm{U - U_e} + \inorm{U_e - u}\\
  &\leq C h^2.
\end{align*}


\subsection{The Fast Poisson Solver}
\Cref{eq:pde:matrixequations} can of course be solved directly with (sparse) matrix solvers like before, but there is a more efficient way.
The \emph{Fast Poisson Solver} exploits properties of the eigenvectors of $K_5$ and $K_9$ to compute the solution efficiently.
In this section, we will explain how this works based on \cite{Strang_2012}.

Just like in \cref{eq:pde:matrixequations}, suppose one is to solve the matrix equation 
$$
K U = h^2 F
$$
for $U$ and that one knows the eigenvectors $y_1, \dots, y_n$ and corresponding eigenvalues $\lambda_1, \dots, \lambda_n$ of $K$.
If $K = K^T$ is invertible and symmetric, the eigenvectors are complete and orthogonal \cite{owren}, so we may write
\begin{equation}
F = c_1 y_1 + c_2 y_2 + \dots + c_n y_n
\qquad \text{with} \qquad
c_i = y_i \cdot F.
\label{eq:pde:fexpansion}
\end{equation}
One may now easily verify by insertion that the solution is
\begin{equation}
U =
\frac{1}{h^2} \left[
	\frac{c_1}{\lambda_1} y_1
	+ \frac{c_2}{\lambda_2} y_2
	+ \dots
	+ \frac{c_n}{\lambda_n} y_n
\right].
\label{eq:pde:insertionsolution}
\end{equation}

We want to solve \cref{eq:pde:matrixequations}, so let us find the eigenvalues and eigenvectors of $K_5$ and $K_9$.
\newcommand{\kroeneckerlemmatext}[2]{
	Let $\alpha_1, \dots, \alpha_m$ be eigenvalues of $A$ with corresponding eigenvectors $x_1, \dots, x_m$.
	Let $\beta_1, \dots, \beta_n$ be eigenvalues of $B$ with corresponding eigenvectors $y_1, \dots, y_n$.
	Then $\alpha_m #2 \beta_n$ are eigenvalues of $A #1 B$ with corresponding eigenvectors $x_m \otimes y_n$.
	In other words,
	\begin{equation*}
		A x_m = \alpha_m x_m
		\quad \text{and} \quad
		B y_n = \beta_n y_n
		\quad \implies \quad
		(A #1 B) (x_m \otimes y_n) = (\alpha_m #2 \beta_n) (x_m \otimes y_n)
		.
	\end{equation*}
}

\begin{lemma}[Eigenvalues of Kroenecker product]\label{pde:lemma:eigkronprod}
\kroeneckerlemmatext{\otimes}{\,}
\end{lemma}
\begin{proof}
See theorem 13.12 on page 141 in \cite{Laub_2004}.
\end{proof}
\begin{lemma}[Eigenvalues of Kroenecker sum]\label{pde:lemma:eigkronsum}
\kroeneckerlemmatext{\oplus}{+}
\end{lemma}
\begin{proof}
See theorem 13.16 on page 143 in \cite{Laub_2004}.
\end{proof}
\begin{lemma}[Eigenvalues of sum of matrices with equal eigenvectors]\label{pde:lemma:eigsum}
Let $\alpha_1, \dots, \alpha_m$ be eigenvalues of $A$ with corresponding eigenvectors $x_1, \dots, x_m$.
Let $\beta_1, \dots, \beta_m$ be eigenvalues of $B$ with the same corresponding eigenvectors.
Then $\alpha_m + \beta_m$ are eigenvalues of $A+B$ with the same eigenvectors.
\end{lemma}
\begin{proof}
$ (A + B) x_i = A x_i + B x_i = \alpha_i x_i + \beta_i x_i = (\alpha_i + \beta_i) x_i.$
\end{proof}
\begin{lemma}\label{pde:lemma:eigtst}
Let $A = \text{tridiag}(b,a,b)$ be a $N \times N$ TST matrix with $a$ on the diagonal and $b$ on the off-diagonal.
Then the eigenvalues $\alpha_1, \dots, \alpha_N$ and eigenvectors $x_1, \dots, x_N$ of $A$ are
\begin{equation}
\alpha_m = a + 2b \cos \left( \frac{m\pi}{N+1} \right)
\quad \text{and} \quad
x_m(k) = \sin \left( \frac{mk\pi}{N+1} \right).
\label{eq:pde:eigtst}
\end{equation}
\end{lemma}
\begin{proof}
See ``The eigenvalues and vectors of a common tridiagonal matrix'' on page 154 in \cite{Smith}.
\end{proof}

With these lemmas, it is now straightforward to obtain the eigenvalues and eigenvectors of $K_5$ and $K_9$.

\newcommand{\eigvecexpr}{\sin \left( \frac{mk\pi}{N+1} \right) \sin \left( \frac{nl\pi}{N+1} \right)}
\begin{theorem}
	The matrices $K_5$ and $K_9$ in \cref{eq:pde:matrixequations} have common eigenvectors
	\begin{equation}
		y_{kl}(m,n)= \eigvecexpr \qquad (1 \leq k,l,m,n \leq M).
		\label{eq:pde:eigenvectors}
	\end{equation}
\end{theorem}
\begin{proof}
	By \cref{pde:lemma:eigtst}, $J_5$, $J_9$ and $\Sigma$ have common eigenvectors given by \cref{eq:pde:eigtst}.
	By \cref{pde:lemma:eigkronprod,pde:lemma:eigkronsum}, $J_5 \oplus J_5$, $J_9 \oplus J_9$ and $\Sigma \otimes \Sigma$ have common eigenvectors given by \cref{eq:pde:eigenvectors}.
	By \cref{pde:lemma:eigsum}, the sum in $(J_9 \oplus J_9) + (\Sigma \otimes \Sigma)$ does not change the eigenvectors.
\end{proof}
Note that it is only $J_5$, $J_9$ and $\Sigma$ that are on the form $\text{tridiag}(b,a,b)$ and are suitable for \cref{pde:lemma:eigtst}.
Like we discussed in \cref{fig:laplace:stencil}, the matrices $K_5$ and $K_9$ themselves are \emph{not}.
\begin{theorem}
The eigenvalues of $K_5$ corresponding to the eigenvectors \ref{eq:pde:eigenvectors} are
\begin{equation}
	\lambda_{kl} = -4 + 2 \cos \left( \frac{k\pi}{N+1} \right) + 2 \cos \left( \frac{l\pi}{N+1} \right).
	\label{eq:pde:eigvals5}
\end{equation}
\end{theorem}
\begin{proof}
	Use \cref{pde:lemma:eigtst} on $J_5$ with appropriate $a$ and $b$.
	Then use \cref{pde:lemma:eigkronsum} on $J_5 \oplus J_5$.
\end{proof}
\begin{theorem}
The eigenvalues of $K_9$ corresponding to the eigenvectors \ref{eq:pde:eigenvectors} are
\begin{equation}
  \lambda_{kl} = -\frac{10}{3} + \frac43 \left( 
                   \cos\left(\frac{k \pi}{N+1}\right) + \cos\left(\frac{l \pi}{N+1}\right) 
               \right) + \frac46 \cos\left(\frac{k \pi}{N+1}\right) \cos\left(\frac{l \pi}{N+1}\right).
  \label{eq:pde:eigvals9}
\end{equation}
\end{theorem}
\begin{proof}
	Use \cref{pde:lemma:eigtst} on $J_9$ and $\Sigma$ with appropriate $a$ and $b$.
	Then use \cref{pde:lemma:eigkronprod} on $\Sigma \otimes \Sigma$ and \cref{pde:lemma:eigkronsum} on $J_9 \oplus J_9$.
	Finally, use \cref{pde:lemma:eigsum} on the sum in $(J_9 \oplus J_9) + (\Sigma \otimes \Sigma)$.
\end{proof}
(TODO: establish one index convention etc., explain the two indices on the eigenvalues)

It is now straightforward to compute $U$ from \ref{eq:pde:fexpansion} and \ref{eq:pde:insertionsolution}.
Inserting the eigenvectors \ref{eq:pde:eigenvectors}, we get
$$
c_{kl} = \sum_{m,n} F(m,n) y_{kl}(m,n) 
       = \sum_{m,n} F(m,n) \eigvecexpr
$$
and
$$
U(m,n) = \sum_{k,l} \frac{c_{kl}}{\lambda_{kl}} y_{kl}(m,n) 
       = \sum_{k,l} \frac{c_{kl}}{\lambda_{kl}} \eigvecexpr
$$
Incidentally, this corresponds \emph{perfectly} to the two-dimensional Discrete Sine Transform of type I (DST-I) and Inverse Discrete Sine Transform (IDST-I), for which very efficient implementations exist in for example \cite{scipy_dst}.
\footnote{
	Note that \cite{scipy_dst} uses different normalization factors and summation indices from \ref{eq:pde:eigenvectors}, but this is easy to handle.
	In addition, it only implements the one-dimensional transform, but this can simply be applied twice to give the two-dimensional transform
	$$
		\sum_{m,n} F(m,n) \eigvecexpr 
		= \underbrace{\sum_m \underbrace{\left(\sum_n F(m,n) \sin\left(\frac{nl\pi}{N+1}\right)\right)}_{\text{1D transform with $m$ fixed}} \sin\left(\frac{mk\pi}{N+1}\right)}_{\text{1D transform}}.
	$$
}
Instead of solving the systems \ref{eq:pde:matrixequations}, we can instead calculate
\begin{equation*}
U = \frac{1}{h^2} \text{IDST}(\text{DST}(F_n) / \Lambda)
\end{equation*}
where $\Lambda$ is the matrix with the eigenvalues \ref{eq:pde:eigvals5} or \ref{eq:pde:eigvals9} corresponding to the right stencil on the diagonal.
This is the awaited and much more efficient Fast Poisson Solver.
Note the strong similarity with the analytical solution \ref{pde:equation:fourierexpansion} -- in both cases the solution is expressed as a sum of discrete or continuous sine functions whose coefficients are given by the inner product between the discrete or contiuous source and basis functions.

\subsection{Demonstration of order}
To demonstrate the order of the five and nine point stencils, we will perform UMR on the Poisson equation, with the inhomogenity $f = -\sin(m \pi x)\sin(n \pi y), ~m=3, n=4$.
(TODO: do we know this from section \ref{sec:pde:anal}?)
From section \ref{sec:pde:anal} we know that the solution to this manufactured problem is
$$
u(x, y) =
\frac{
  \sin(m \pi x)\sin(n \pi y)
}{
  (n\pi)^2 + (m\pi)^2
}
, ~m=3, n=4.
$$
The mesh refinement is done with the same number of discretization points in $x$- and $y$-direction.
The values used are $N = N_x = N_y = \{8, 16, 32, 64, 128, 256\}$.
The solution is shown in figure \ref{fig:pde:order_solution}.
The relative error as a function of $N$ is shown in figure \ref{fig:pde:order}.
As expected, the error for the five point stencil goes as $h^2$ while the error for the nine point stencil goes as $h^4$.


\begin{figure}[tb]
  \centering
  \begin{subfigure}[t]{0.48\textwidth}
    \showSurf{./PDE/solution_PoissonSolver_N_37.dat}{39}{$U(x, y)$}
    \caption{The approximated solution $U(x, y)$.}
    \label{fig:pde:order_solution}
  \end{subfigure}
  ~
  \begin{subfigure}[t]{0.48\textwidth}

    \centering \input{./PDE/order.pgf}
    \caption{Relative error.
      Also shown are $Ch^2$ and $Ch^4$, which are the expected convergence rates of the five and nine point stencil respectively.
      The constants are chosen such that the $h^2$ and $h^4$ line appears close to the stencil errors.
      First axis shows degrees of freedom $N^2$, where $N$ is the number of internal discretization points in one direction.
    }
    \label{fig:pde:order}
  \end{subfigure}
  \caption{Solving the Poisson equation on the manufactured problem $f=-\sin(m \pi x)\sin(n\pi y), ~m = 3, n=4$, with analytical solution $u(x, y) = \sin(m \pi x)\sin(n \pi y) / ((n\pi)^2 + (m\pi)^2)$.
    Solved with equal number of discretization points in $x$ and $y$ direction.
    Subfigure \subref{fig:pde:order_solution} shows the analytical solution $u$, while \subref{fig:pde:order} shows the relative error for the five and nine point stencil.
  }
\end{figure}


\subsection{Solving the Biharmonic equation}
\label{sec:pde:solving}
We will now solve \eqref{eq:PDE} numerically on a manufactured problem.
Let
$$
u(x, y) =
\left(
\sin \pi x
\sin \pi y
\right)^4
e^{-(x-0.5)^2 - (y-0.5)^2}.
$$
The inhomogenity $f$ is simply found by calculating $\nabla^4 u$.
The result, which was found using a computer algebra system, is somewhat lengthy, and therefore only included as an appendix for the sake of readability.



According to equation \eqref{eq:PDE-poisson} we split the equation into a system of poisson equations by introducing a new function $g$:
\begin{align}\label{eq:biharmonic_poisson}
  \begin{split}
    \nabla^2g &= f,\\
    \nabla^2u &= g,\\
    g = u &= 0,\quad \text{ on } \partial \Omega.
  \end{split}
\end{align}
It is now simply a matter of applying the described Fast Poisson Solver sequentially for the two equations.

The numerical solution is shown in figure \ref{fig:pde:bvp}.
In figure \ref{fig:pde:bvp_convergence} a convergence plot as a function of the degrees of freedom is shown, and the computation time is shown in figure \ref{fig:pde:bvp_time}.
(TODO: we could probably have solved for higher numbers... maybe change to ``we solved for ...'')
We were able to solve the equation with a maximal discretization of $N = 3000$ in one direction, so about \num{1e7} grid points.

\subsubsection{A possible improvement to the Biharmonic solver with nine point stencil}
The fourth order nine point stencil may be written as
\begin{equation}\label{eq:nine_point_stencil}
  \nabla_9^2 U
  = \left(I + \frac{h^2}{12} \nabla_5^2\right) F.
\end{equation}
Recall that the five point stencil on the right hand side emerged as a consequence of
$\inorm{(\nabla^2 - \nabla_5^2)u} = \frac{h^2}{12}\nabla^2 f$
to order $h^2$.
The laplace operator was later approximated using the five point stencil, after it was shown that this conserved the fourth order convergence, resulting in \eqref{eq:nine_point_stencil}.

Return now to the Biharmonic equation.
Upon solving the second Poisson equation in \eqref{eq:biharmonic_poisson}, the nine point stencil equation is
\begin{equation}
    \nabla_9^2 U
    = \left(I + \frac{h^2}{12} \nabla_5^2\right) G.
\end{equation}
However, we already have an exact expression for $\nabla^2 g$ -- the inhomogenity $f$!
Thus, we may solve the equation 
\begin{equation}
    \nabla_9^2 U
    = \left(G + \frac{h^2}{12} F\right),
\end{equation}
and have thus eluded the computation of $\nabla_5^2 G$.


  %% \caption{The numerical solution $U(x, y)$ to the Biharmonic equation, using the nine point stencil with discretization $N=20$ in each direction. TODO:write more}
  %% \label{fig:pde:bvp}
  %% \end{figure}

%% Error plot
\begin{figure}[hbp]
  \centering

  \begin{subfigure}[t]{0.49\textwidth}
    \centering
    \showSurf{./PDE/testF.dat}{100}{$f(x, y)$}[flat]
    \caption{The inhomogenity $f(x, y)$ used when solving the Biharmonic equation. The function is not zero on the entire border of the domain.}
  \end{subfigure}
  ~
  %% Solution plot
  \begin{subfigure}[t]{0.49\textwidth}
    \centering
    \showSurf{./PDE/solution_BiharmonicSolver_N_20.dat}{22}{$u(x, y)$}
    \caption{The numerical solution $U(x, y)$ to the Biharmonic equation, using the nine point stencil with discretization $N=20$ in each direction.  TODO: does it work to have it here?}
    \label{fig:pde:bvp}
  \end{subfigure}

  \begin{subfigure}[t]{0.49\textwidth}
    \begin{tikzpicture}
      \begin{loglogaxis}[
          title={},
          xlabel={$\text{DoF} = N^2$},
          ylabel={Relative error, $\lVert u - v \rVert_2 / \lVert u \rVert_2$},
          legend pos=south west,
          xmin=6^2, xmax=10e6,%2400^2,
          ymin=10e-12, ymax=2,
		      width=7.7cm,
        ]
        \addplot table[x expr=\thisrow{N}^2, y={nine}] {./PDE/error_BiharmonicSolver_N_8:1300:10.dat};
        \addlegendentry{Nine point};

        \addplot table[x expr=\thisrow{N}^2, y={five}] {./PDE/error_BiharmonicSolver_N_8:1300:10.dat};
        \addlegendentry{Five point};


        \addplot[black, dashed, domain = 6^2:2600^2, samples=2] {30/(sqrt(x)+1)^2}
        node[pos=0.7,
          pin={[pin edge={solid, out=45, in=-120}]above right:$\mathcal{O}(h^2)$},
        ] {};

        \addplot[black, dashed, domain = 6^2:2400^2, samples=2] {80/(sqrt(x)+1)^4}
        node[pos=0.3,
          pin={[pin edge={solid, out=-120, in=45}]below left:$\mathcal{O}(h^4)$},
        ] {};
      \end{loglogaxis}
    \end{tikzpicture}
    \caption{
      The relative error of the numerical solution.
      TODO: Could add five point for comparison?}
    \label{fig:pde:bvp_convergence}
  \end{subfigure}
  ~
  %% Computation time plot
  \begin{subfigure}[t]{0.49\textwidth}
    \centering
    \begin{tikzpicture}
      \begin{loglogaxis}[
          title={},
          xlabel={$\text{DoF} = N^2$},
          ylabel={Computation time [s]},
          legend pos=north west,
		  width=7.7cm
        ]
        \addplot table[x expr=\thisrow{N}^2, y={time}] {PDE/comp_bvp_no_fps.dat};
        \addlegendentry{Scipy Sparse Solver};
        \addplot table[x expr=\thisrow{N}^2, y={time}] {PDE/comp_bvp_fps.dat};
        \addlegendentry{Fast Poisson Solver};

        %% \addplot[mark=none] table[x expr=\thisrow{N}^2,
        %%   y={create col/linear regression={
        %%       y=time,
        %%       variance list={1000,1000,1000,1000}, %% Ignore first points
        %% }}]  {PDE/comp_bvp_fps.dat}
        %% node[pos=0.3,
        %%   pin={[pin edge={solid}]below right:$a = \pgfplotstableregressiona$},
        %% ] {};

        %% \addplot[mark=none, dashed] table[x expr=\thisrow{N}^2,
        %%   y={create col/linear regression={
        %%       y=time,
        %%       variance list={1000,1000,1000}, %% Ignore first points
        %% }}] {PDE/comp_bvp_no_fps.dat};

        %% \addplot[domain=10^2:10^6] {1e-6 * x^(3/2)};
        %% \addplot[domain=10^2:10^6, dashed] {1e-8 * x * ln(x)};
        %% \addplot[domain=10^2:10^6, dashdotted] {1e-8 * x};

        %% \addplot[domain=8:256] {0.0001 * x * ln(x)};
        %% \addplot[domain=8:256] {0.0001 * x^2};
      \end{loglogaxis}
    \end{tikzpicture}
    \caption{
      Computation time.
      Computation times for two solvers shown, the Scipy Sparse Solver\cite{scipy_sparse_linalg_spsolve} and our own Fast Poisson Solver.
    }
    \label{fig:pde:bvp_time}
  \end{subfigure}
  \caption{Error and computation time solving the clamped Biharmonic equation on the manufactured problem with analytical solution
    $\left(
    \sin \pi x
    \sin \pi y
    \right)^4
    e^{-(x-0.5)^2 - (y-0.5)^2}$.
    Figure \subref{fig:pde:bvp_convergence} shows the relative error using the nine point stencil, while figure \subref{fig:pde:bvp_time} shows the computation time.
    Both are plottet with degrees of freedom on the first axis, the total number of internal points $N^2$.
  }
\end{figure}


%% For creating convergence plots and to use as a test on the validity of our approach, we will also find the analytical solution to the equation.
%% The function $f$ fulfills $f(x,y) = 0$ for $(x,y)\in \partial\Omega$, and we may thus use the analytical results derived in section \ref{sec:pde:anal}.
%% Fourier transforming $f$ results in 
%% \begin{equation*}
%% 	\hat{f}_{mn} =
%% 	\left[ 2 \integral{\sin^4(\pi x) \sin(m \pi x) e^{-(x-1/2)^2}}{x}{0}{1}\right]
%% 	\left[ 2 \integral{\sin^4(\pi y) \sin(n \pi y) e^{-(y-1/2)^2}}{y}{0}{1}\right].
%% \end{equation*}
%% The integrals do have analytical solutions, but they are not easy to compute.
%% We have computed them with the SAGE CAS suite.
%% Below is an easy-to-copy expression for the first bracket $ = I(m)$ in the equation above.
%% Then $\hat{f}_{mn} = I(m) \, I(n)$.
%% %% Old wrong result
%% %% >>> I(m) = 48*(pi^9*m^5*e^2 - 20*(pi^9*e^2 + 2*pi^7*e^2)*m^3 - (pi^9*m^5 - 20*(pi^9 + 2*pi^7)*m^3 + 16*(4*pi^9 + 15*pi^7 + 5*pi^5)*m)*(-1)^m + 16*(4*pi^9*e^2 + 15*pi^7*e^2 + 5*pi^5*e^2)*m)/(pi^10*m^10*e^3 - 20*(2*pi^10*e^3 - pi^8*e^3)*m^8 + 16384*pi^8*e^3 + 16*(33*pi^10*e^3 - 20*pi^8*e^3 + 10*pi^6*e^3)*m^6 + 40960*pi^6*e^3 - 320*(8*pi^10*e^3 - 7*pi^8*e^3 - 2*pi^4*e^3)*m^4 + 33792*pi^4*e^3 + 256*(16*pi^10*e^3 + 35*pi^6*e^3 + 20*pi^4*e^3 + 5*pi^2*e^3)*m^2 + 10240*pi^2*e^3 + 1024*e^3)
%% \begin{lstlisting}
%% I(m) = 2 * integral(sin(pi*x)^4*sin(m*pi*x)*exp(-(x-1/2)^2), x, 0, 1)
%% >> 1/16*sqrt(pi)*(erf(-2*I*pi + 1/2*I*pi*m + 1/2)*e^(4*pi^2*m)*sin(1/2*pi*m) - erf(-2*I*pi + 1/2*I*pi*m - 1/2)*e^(4*pi^2*m)*sin(1/2*pi*m) + 4*erf(-I*pi + 1/2*I*pi*m + 1/2)*e^(3*pi^2*m + 3*pi^2)*sin(1/2*pi*m) - 4*erf(-I*pi + 1/2*I*pi*m - 1/2)*e^(3*pi^2*m + 3*pi^2)*sin(1/2*pi*m) + 6*erf(1/2*I*pi*m + 1/2)*e^(2*pi^2*m + 4*pi^2)*sin(1/2*pi*m) - 6*erf(1/2*I*pi*m - 1/2)*e^(2*pi^2*m + 4*pi^2)*sin(1/2*pi*m) + 4*erf(I*pi + 1/2*I*pi*m + 1/2)*e^(pi^2*m + 3*pi^2)*sin(1/2*pi*m) - 4*erf(I*pi + 1/2*I*pi*m - 1/2)*e^(pi^2*m + 3*pi^2)*sin(1/2*pi*m) + erf(2*I*pi + 1/2*I*pi*m + 1/2)*sin(1/2*pi*m) - erf(2*I*pi + 1/2*I*pi*m - 1/2)*sin(1/2*pi*m))*e^(-1/4*pi^2*m^2 - 2*pi^2*m - 4*pi^2)

%% Funnet f etter ny endring:
%% 4*(6*pi^4*e^(x + y)*sin(pi*x)^4 - 8*(4*pi*y^3*e^x*sin(pi*x)^4 - 6*pi*y^2*e^x*sin(pi*x)^4 - 6*pi^3*e^x*sin(pi*x)^2 + 4*(2*pi^2*x - pi^2)*cos(pi*x)*e^x*sin(pi*x)^3 + (3*pi + 16*pi^3 - 2*pi*x^2 + 2*pi*x)*e^x*sin(pi*x)^4 + 4*(3*pi^3*e^x*sin(pi*x)^2 - 2*(2*pi^2*x - pi^2)*cos(pi*x)*e^x*sin(pi*x)^3 - (pi + 8*pi^3 - pi*x^2 + pi*x)*e^x*sin(pi*x)^4)*y)*cos(pi*y)*e^y*sin(pi*y)^3 + (4*y^4*e^x*sin(pi*x)^4 - 8*y^3*e^x*sin(pi*x)^4 - 8*(3*pi + 4*pi*x^3 + 16*pi^3 - 6*pi*x^2 - 4*(pi + 8*pi^3)*x)*cos(pi*x)*e^x*sin(pi*x)^3 + (256*pi^4 + 4*x^4 - 8*(16*pi^2 + 1)*x^2 - 8*x^3 + 64*pi^2 + 4*(32*pi^2 + 3)*x + 1)*e^x*sin(pi*x)^4 + 6*pi^4*e^x - 24*(2*pi^3*x - pi^3)*cos(pi*x)*e^x*sin(pi*x) - 12*(13*pi^4 - 6*pi^2*x^2 + 6*pi^2*x + 2*pi^2)*e^x*sin(pi*x)^2 + 8*(2*(pi - 2*pi*x)*cos(pi*x)*e^x*sin(pi*x)^3 - (16*pi^2 - x^2 + x + 1)*e^x*sin(pi*x)^4 + 3*pi^2*e^x*sin(pi*x)^2)*y^2 - 4*(4*(pi - 2*pi*x)*cos(pi*x)*e^x*sin(pi*x)^3 - (32*pi^2 - 2*x^2 + 2*x + 3)*e^x*sin(pi*x)^4 + 6*pi^2*e^x*sin(pi*x)^2)*y)*e^y*sin(pi*y)^4 - 24*(2*pi^3*y*e^x*sin(pi*x)^4 - pi^3*e^x*sin(pi*x)^4)*cos(pi*y)*e^y*sin(pi*y) + 12*(6*pi^2*y^2*e^x*sin(pi*x)^4 - 6*pi^2*y*e^x*sin(pi*x)^4 + 6*pi^4*e^x*sin(pi*x)^2 - 4*(2*pi^3*x - pi^3)*cos(pi*x)*e^x*sin(pi*x)^3 - (13*pi^4 - 2*pi^2*x^2 + 2*pi^2*x + 2*pi^2)*e^x*sin(pi*x)^4)*e^y*sin(pi*y)^2)*e^(-x^2 - y^2 - 1/2)
%% \end{lstlisting}
%% Something something sine transform.




%% \begin{figure}
%% \begin{tikzpicture}
%% \begin{axis}[
%% 	xmin=0, xmax=27,
%% 	declare function={
%% 		myfunc(\m)=48*(pi^9*(\m)^5*e^2 - 20*(pi^9*e^2 + 2*pi^7*e^2)*(\m)^3 - (pi^9*(\m)^5 - 20*(pi^9 + 2*pi^7)*(\m)^3 + 16*(4*pi^9 + 15*pi^7 + 5*pi^5)*(\m))*(-1)^(\m) + 16*(4*pi^9*e^2 + 15*pi^7*e^2 + 5*pi^5*e^2)*(\m))/(pi^10*(\m)^10*e^3 - 20*(2*pi^10*e^3 - pi^8*e^3)*(\m)^8 + 16384*pi^8*e^3 + 16*(33*pi^10*e^3 - 20*pi^8*e^3 + 10*pi^6*e^3)*(\m)^6 + 40960*pi^6*e^3 - 320*(8*pi^10*e^3 - 7*pi^8*e^3 - 2*pi^4*e^3)*(\m)^4 + 33792*pi^4*e^3 + 256*(16*pi^10*e^3 + 35*pi^6*e^3 + 20*pi^4*e^3 + 5*pi^2*e^3)*(\m)^2 + 10240*pi^2*e^3 + 1024*e^3);
%% 	},
%% 	xtick={1,6,...,26},
%% 	minor x tick num=4,
%% 	xlabel=$m$, title={$I(m)$},
%% ]
%% \addplot [domain=1:26, samples=26, mark=*] {myfunc(x)};
%% \addplot [domain=0:27, samples=2, dashed] {0};
%% \end{axis}
%% \end{tikzpicture}
%% \end{figure}

